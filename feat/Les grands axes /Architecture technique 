# Architecture Technique

# **ğŸ—ï¸ MASTER SHEETÂ - Sophia**

**ARCHITECTURE TECHNIQUE "AI-NATIVE" & FULL CODE**

**Objectif :**Â DÃ©ploiement d'uneÂ Web App haute performance et d'un Ã©cosystÃ¨me IA autonome.

**Philosophie :**Â ZÃ©ro dette technique, ZÃ©ro No-Code, ContrÃ´le totalÂ via le code.

**Stack Principale :**Â React (Vite) + Supabase (BaaS) + Deno Edge Functions + OpenAI/Gemini.

---

## **1. LE FRONTEND (L'INTERFACE UTILISATEUR)**

*Le visage de la transformation. Rapide, fluide, sans friction.*

**Technologie :**Â React + Vite + TypeScript.

**HÃ©bergement :**Â Vercel (DÃ©ploiement continu depuis GitHub).

### **A. Architecture Visuelle & UX**

- **Framework CSS :**Â **Tailwind CSS v4**. Utilisation du moteur natif pour une performance maximale.
- **Design System :**Â Mode "Light" pur. FondÂ gray-50, TexteÂ gray-900, Accents sÃ©mantiquesÂ (Violet=Coachy, Bleu=Homme, Rose=Femme).
- **Composants Atomiques :**
- **Boutons Globaux :**Â "Sticky Footer" (Barre fixe en bas d'Ã©cran) pour la validation des actions majeures (GÃ©nÃ©rer le plan, Valider laÂ journÃ©e). / **La validation de la journÃ©e se fait via whatsapp, via des messages envoyÃ©s au bon moment en fonction**
- **Cards "SystÃ¨me" :**Â Cartes interactives injectÃ©es dynamiquement (Titre, Mantra, Checkbox, Audio PlayerÂ conditionnel). / Les
- **Feedback Visuel :**Â Confettis pourÂ les victoires (J+3), Modales douces pour les micro-Ã©checs.

**B. Logique Onboarding (Interne)**

*Remplacement de Tally par un formulaire natif.*

- **SPAÂ (Single Page Application) :**Â Le questionnaire est intÃ©grÃ© directement dans l'applicationÂ React (/onboarding).
- **Logique de SÃ©lection :**
- Contrainte stricte : 1 Axe par ThÃ¨me.
- Limite globale : Max 3 Axes actifs (RÃ¨gle des "3 Piliers").
- **Flux de DonnÃ©es :**Â Ã€ la validation, leÂ JSON complet des rÃ©ponses est envoyÃ© directement Ã  Supabase, dÃ©clenchant instantanÃ©ment laÂ gÃ©nÃ©ration du Plan (Agent A2) sans passer par un webhook externe fragile.

### **C. SÃ©curitÃ© & Session**

- **Auth :**Â Supabase Auth (Email/Password ).
- **Protection des Routes :**Â MiddlewareÂ React (RequireAuth) qui redirige systÃ©matiquement les utilisateurs non connectÃ©s versÂ /login.
- **Auto-Logout (SÃ©curitÃ© Bancaire) :**Â TimerÂ d'inactivitÃ© (IdleTimer) de 30 minutes. Si aucuneÂ souris/clavier dÃ©tectÃ© â†’ DÃ©connexion forcÃ©e pour protÃ©ger les donnÃ©es intimes.

---

## **2. LE BACKEND & DONNÃ‰ESÂ (LE CERVEAU)**

*Toute l'intelligence est centralisÃ©e chez Supabase. Pas de serveur Ã  gÃ©rer.*

**Technologie :**Â Supabase Cloud.

**A. Base de DonnÃ©es Relationnelle (PostgreSQL)**

Structure stricte pour garantir l'intÃ©gritÃ© du parcours utilisateur.

- **usersÂ :**Â ID, Email, PrÃ©nom, Timezone (pour lesÂ notifications locales), Date d'inscription.
- **onboarding_answersÂ :**Â Stockage brut du JSON des rÃ©ponses au questionnaire (Source de vÃ©ritÃ© pour l'IA).
- **themesÂ &Â axesÂ :**Â Tables deÂ rÃ©fÃ©rence (SLP, ENG, CNF...) pour Ã©viter les erreurs de typage par l'IA.
- **plansÂ :**Â LeÂ "Contrat" en cours (Date de dÃ©but, Axes choisis, Statut).
- **objectivesÂ :**Â Les buts spÃ©cifiques liÃ©s au planÂ (Lien direct vers les Axes).
- **actionsÂ :**Â LesÂ tÃ¢ches quotidiennes (Titre, Description, Heure, Statut, Mantra).
- **logsÂ :**Â Historique de toutes les interactions (Chat WhatsAppÂ + Validations Web).

**B. MÃ©moire Vectorielle (RAG AvancÃ©)**

Pour que Sophia n'oublie jamais rien.

- **Extension :**Â pgvectorÂ activÃ© sur Supabase.
- **StratÃ©gie de Filtrage (Metadata Filtering) :**
- Chaque souvenir est taguÃ© (ex:Â category: 'SLP',Â emotion: 'anxiety').
- Avant de rÃ©pondre, l'IA neÂ charge que les souvenirs pertinents pour la conversation en cours (Ã‰conomie de tokensÂ + PrÃ©cision).
- **Architecture MÃ©moire 3 NiveauxÂ :**
1. **Buffer (Court terme) :**Â 10 derniers messages bruts (FluiditÃ© conversationnelle).
2. **Journal (Moyen terme) :**Â SynthÃ¨se quotidienne vectorisÃ©e par Cron Job la nuit.
3. **Core (Long terme) :**Â CroyancesÂ limitantes et Traumas (Score de rÃ©tention 5/5, jamais archivÃ©s).

---

## **3. L'INTELLIGENCE (AGENTS & EDGE FUNCTIONS)**

*Le moteur qui anime le produit. HÃ©bergÃ© sur Supabase Edge Functions (Deno).*

### **A. L'OrchestrationÂ des Agents**

- **A1 â€” Sophia (Chat) :**
- Trigger : Message WhatsApp entrant (Webhook Twilio).
- RÃ´le : Empathie, Soutien, Aiguillage vers l'App.
- SÃ©curitÃ© : Analyse de sentiment avant rÃ©ponse (Flagging suicide/dÃ©tresse).
- **A2 â€” L'Architecte (Plan Global) :**
- Trigger : Validation du Formulaire Onboarding React.
- RÃ´le : Analyse les rÃ©ponses, sÃ©lectionne les 3 axes, rÃ©dige la "Vision".
- **A3 â€” Le StratÃ¨ge (PlanÂ d'Action) :**
- Trigger : Fin du travail deÂ A2.
- RÃ´le : GÃ©nÃ¨re les entrÃ©es dansÂ la tableÂ actionsÂ (Quoi, Quand, Comment, Pourquoi).
- **A4 â€” Le MÃ©canicien (Ajustement) :**
- Trigger : Demande utilisateur "C'est trop dur" ou "JeÂ m'ennuie".
- RÃ´le : Modifie la difficultÃ© desÂ actions en base de donnÃ©es.
- **A5 â€” L'HypnothÃ©rapeute (Audio) :**
- Trigger : DÃ©tection deÂ blocage Ã©motionnel profond.
- RÃ´le : GÃ©nÃ¨re scriptÂ â†’ Hash Check (Cache) â†’ ElevenLabs API â†’ Supabase Storage.
- **A6 â€” Le Filet de SÃ©curitÃ© (Micro-Actions) :**
- Trigger : Cron Job (7 jours sans validation).
- RÃ´le : Remplace une action bloquÃ©e par une version "Ridiculement facile".

### **B. Automatisations Temporelles (Cron Jobs)**

- **TimezoneÂ Aware :**Â Les scripts tournent toutes les heures et scannent :Â *"Qui sont les utilisateurs pour qui il est 9h00 ?"*
- **Routine de Suivi :**Â VÃ©rifie les validations de la veille.
- 3 jours succÃ¨s â†’ Trigger Message FÃ©licitation + DÃ©blocage niveauÂ suivant.
- Silence radio â†’ Trigger Message "Douceur" (Pas de culpabilisation).

---

## **4. FLUXÂ & CONNECTIVITÃ‰ (LES TUYAUX)**

### **A. WhatsApp (Twilio)**

- Interface bidirectionnelle.
- Webhook sÃ©curisÃ© (vÃ©rification de signature X-Twilio-Signature) sur Supabase Edge Function.
- Tout message est loggÃ© dansÂ logsÂ avant d'ÃªtreÂ traitÃ©.

### **B. Optimisation des CoÃ»ts (API Smart Caching)**

- **Audio Hash-Caching :**
- AvantÂ de gÃ©nÃ©rer un audio (coÃ»teux), on calcule le HASHÂ du texte.
- On vÃ©rifie dans le Storage si ce HashÂ existe.
- Oui ? â†’ On sert le fichier existant (Gratuit).
- Non ? â†’ On appelle ElevenLabs.
- **LLM Context Pruning :**Â On ne nourrit le LLM qu'avec les donnÃ©esÂ vectorielles strictement nÃ©cessaires (Top-K similarity) pour rÃ©duire la facture OpenAI.

---

## **5. WORKFLOW DE DÃ‰VELOPPEMENTÂ (PROMPT ENGINEERING)**

*Comment nous construisons cela avec Gemini & Cursor.*

1. **Context First :**Â Toujours initialiser la session avec la Master Sheet.
2. **AtomicitÃ© :**Â Une fonctionnalitÃ© = Un Prompt. NeÂ jamais demander "Fais tout le dashboard", mais "Connecte le composant Card Ã Â la table Actions".
3. **Naming Convention :**Â Le code doit utiliser EXCLUSIVEMENT les termes de la DB (objectivesÂ et nonÂ goals,Â axesÂ et nonÂ categories).
4. **Validation parÂ l'Humain :**Â Chaque itÃ©ration critique (Auth, Paiement, GÃ©nÃ©rationÂ IA) est testÃ©e manuellement avant de passer Ã  la suite.